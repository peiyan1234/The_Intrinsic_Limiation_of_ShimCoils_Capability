function SHfield=Spherical_Harmonics_Generator(Xsize,Ysize,Zsize,Axes_Orientation,voxel_size,order,degree,shim_mode)
% SHfield=Spherical_Harmonics_Generator(x,y,z,size,order,term)
% ex: Xsize=88, Ysize=100, Zsize=70, Axes_Orientation=[1,-1,-1],
% ex: voxel_size=[1,1,1] (mm), order=4, degree=3, shim_mode='Dynamic' or 'Global'
% Created by:
% Pei-Yan, Li
% National Taiwan University

if abs(degree)>order
    error('***Error input! The degree must be smaller than the order***');
end

% if order>10
%     error('***Error! The order cannot be higher than 10!***');
% end

SHfield=zeros(length(Xsize),length(Ysize),length(Zsize));

[Y,X,Z]=meshgrid(-Ysize/2:Ysize/2-1,-Xsize/2:Xsize/2-1,-Zsize/2:Zsize/2-1);
x=X*voxel_size(1)*Axes_Orientation(1);
y=Y*voxel_size(2)*Axes_Orientation(2);
if string(shim_mode)=='Global'
    z=Z*voxel_size(3)*Axes_Orientation(3);
elseif string(shim_mode)=='Dynamic'
    z=Z*voxel_size(3)*Axes_Orientation(3)*0;
end

if order>10
    if order==0 & degree==0
        SHfield=ones(Xsize,Ysize,Zsize);
    else
        SH_f=Solid_harmonics_formula(order,degree);
        str=string(SH_f);
        old_1="*";new_1=".*";
        old_2="^";new_2=".^";
        new_str=replace(replace(str,old_1,new_1),old_2,new_2);
        SHfield=eval(new_str);
    end
end

if order<=10
    switch order
        case 0
            switch degree
                case 0
                    SHfield=ones(Xsize,Ysize,Zsize);
            end
        case 1
            switch degree
                case -1
                    SHfield=y;
                case 0
                    SHfield=z;
                case 1
                    SHfield=x;
            end
        case 2
            switch degree
                case -2
                    SHfield=6*x.*y;
                case -1
                    SHfield=3*y.*z;
                case 0
                    SHfield=- x.^2/2 - y.^2/2 + z.^2;
                case 1
                    SHfield=3*x.*z;
                case 2
                    SHfield=3*x.^2 - 3*y.^2;
            end
        case 3
            switch degree
                case -3
                    SHfield=45*x.^2.*y - 15*y.^3;
                case -2
                    SHfield=30*x.*y.*z;
                case -1
                    SHfield=-(3*y.*(x.^2 + y.^2 - 4*z.^2))/2;
                case 0
                    SHfield=-(z.*(3*x.^2 + 3*y.^2 - 2*z.^2))/2;
                case 1
                    SHfield=-(3*x.*(x.^2 + y.^2 - 4*z.^2))/2;
                case 2
                    SHfield=15*z.*(x.^2 - y.^2);
                case 3
                    SHfield=15*x.*(x.^2 - 3*y.^2);
            end
        case 4
            switch degree
                case -4
                    SHfield=420*x.*y.*(x.^2 - y.^2);
                case -3
                    SHfield=105*y.*z.*(3*x.^2 - y.^2);
                case -2
                    SHfield=-15*x.*y.*(x.^2 + y.^2 - 6*z.^2);
                case -1
                    SHfield=-(5*y.*z.*(3*x.^2 + 3*y.^2 - 4*z.^2))/2;
                case 0
                    SHfield=(3*x.^4)/8 + (3*x.^2.*y.^2)/4 - 3*x.^2.*z.^2 + (3*y.^4)/8 - 3*y.^2.*z.^2 + z.^4;
                case 1
                    SHfield=-(5*x.*z.*(3*x.^2 + 3*y.^2 - 4*z.^2))/2;
                case 2
                    SHfield=-(15*(x.^2 - y.^2).*(x.^2 + y.^2 - 6*z.^2))/2;
                case 3
                    SHfield=105*x.*z.*(x.^2 - 3*y.^2);
                case 4
                    SHfield=105*x.^4 - 630*x.^2.*y.^2 + 105*y.^4;
            end
        case 5
            switch degree
                case -5
                    SHfield=945*y.*(5*x.^4 - 10*x.^2.*y.^2 + y.^4);
                case -4
                    SHfield=3780*x.*y.*z.*(x.^2 - y.^2);
                case -3
                    SHfield=-(105*y.*(3*x.^2 - y.^2).*(x.^2 + y.^2 - 8*z.^2))/2;
                case -2
                    SHfield=-105*x.*y.*z.*(x.^2 + y.^2 - 2*z.^2);
                case -1
                    SHfield=(15*y.*(x.^4 + 2*x.^2.*y.^2 - 12*x.^2.*z.^2 + y.^4 - 12*y.^2.*z.^2 + 8*z.^4))/8;
                case 0
                    SHfield=(z.*(15*x.^4 + 30*x.^2.*y.^2 - 40*x.^2.*z.^2 + 15*y.^4 - 40*y.^2.*z.^2 + 8*z.^4))/8;
                case 1
                    SHfield=(15*x.*(x.^4 + 2*x.^2.*y.^2 - 12*x.^2.*z.^2 + y.^4 - 12*y.^2.*z.^2 + 8*z.^4))/8;
                case 2
                    SHfield=-(105*z.*(x.^2 - y.^2).*(x.^2 + y.^2 - 2*z.^2))/2;
                case 3
                    SHfield=-(105*x.*(x.^2 - 3*y.^2).*(x.^2 + y.^2 - 8*z.^2))/2;
                case 4
                    SHfield=945*z.*(x.^4 - 6*x.^2.*y.^2 + y.^4);
                case 5
                    SHfield=945*x.*(x.^4 - 10*x.^2.*y.^2 + 5*y.^4);
            end
        case 6
            switch degree
                case -6
                    SHfield=20790*x.*y.*(3*x.^4 - 10*x.^2.*y.^2 + 3*y.^4);
                case -5
                    SHfield=10395*y.*z.*(5*x.^4 - 10*x.^2.*y.^2 + y.^4);
                case -4
                    SHfield=-1890*x.*y.*(x.^2 - y.^2).*(x.^2 + y.^2 - 10*z.^2);
                case -3
                    SHfield=-(315*y.*z.*(3*x.^2 - y.^2).*(3*x.^2 + 3*y.^2 - 8*z.^2))/2;
                case -2
                    SHfield=(105*x.*y.*(x.^4 + 2*x.^2.*y.^2 - 16*x.^2.*z.^2 + y.^4 - 16*y.^2.*z.^2 + 16*z.^4))/4;
                case -1
                    SHfield=(21*y.*z.*(5*x.^4 + 10*x.^2.*y.^2 - 20*x.^2.*z.^2 + 5*y.^4 - 20*y.^2.*z.^2 + 8*z.^4))/8;
                case 0
                    SHfield=- (5*x.^6)/16 - (15*x.^4.*y.^2)/16 + (45*x.^4.*z.^2)/8 - (15*x.^2.*y.^4)/16 + (45*x.^2.*y.^2.*z.^2)/4 - (15*x.^2.*z.^4)/2 - (5*y.^6)/16 + (45*y.^4.*z.^2)/8 - (15*y.^2.*z.^4)/2 + z.^6;
                case 1
                    SHfield=(21*x.*z.*(5*x.^4 + 10*x.^2.*y.^2 - 20*x.^2.*z.^2 + 5*y.^4 - 20*y.^2.*z.^2 + 8*z.^4))/8;
                case 2
                    SHfield=(105*(x.^2 - y.^2).*(x.^4 + 2*x.^2.*y.^2 - 16*x.^2.*z.^2 + y.^4 - 16*y.^2.*z.^2 + 16*z.^4))/8;
                case 3
                    SHfield=-(315*x.*z.*(x.^2 - 3*y.^2).*(3*x.^2 + 3*y.^2 - 8*z.^2))/2;
                case 4
                    SHfield=-(945*(x.^4 - 6*x.^2.*y.^2 + y.^4).*(x.^2 + y.^2 - 10*z.^2))/2;
                case 5
                    SHfield=10395*x.*z.*(x.^4 - 10*x.^2.*y.^2 + 5*y.^4);
                case 6
                    SHfield=10395*x.^6 - 155925*x.^4.*y.^2 + 155925*x.^2.*y.^4 - 10395*y.^6;
            end
        case 7
            switch degree
                case -7
                    SHfield=135135*y.*(7*x.^6 - 35*x.^4.*y.^2 + 21*x.^2.*y.^4 - y.^6);
                case -6
                    SHfield=270270*x.*y.*z.*(3*x.^4 - 10*x.^2.*y.^2 + 3*y.^4);
                case -5
                    SHfield=-(10395*y.*(x.^2 + y.^2 - 12*z.^2).*(5*x.^4 - 10*x.^2.*y.^2 + y.^4))/2;
                case -4
                    SHfield=-6930*x.*y.*z.*(x.^2 - y.^2).*(3*x.^2 + 3*y.^2 - 10*z.^2);
                case -3
                    SHfield=(315*y.*(3*x.^2 - y.^2).*(3*x.^4 + 6*x.^2.*y.^2 - 60*x.^2.*z.^2 + 3*y.^4 - 60*y.^2.*z.^2 + 80*z.^4))/8;
                case -2
                    SHfield=(63*x.*y.*z.*(15*x.^4 + 30*x.^2.*y.^2 - 80*x.^2.*z.^2 + 15*y.^4 - 80*y.^2.*z.^2 + 48*z.^4))/4;
                case -1
                    SHfield=-(7*y.*(5*x.^6 + 15*x.^4.*y.^2 - 120*x.^4.*z.^2 + 15*x.^2.*y.^4 - 240*x.^2.*y.^2.*z.^2 + 240*x.^2.*z.^4 + 5*y.^6 - 120*y.^4.*z.^2 + 240*y.^2.*z.^4 - 64*z.^6))/16;
                case 0
                    SHfield=-(z.*(35*x.^6 + 105*x.^4.*y.^2 - 210*x.^4.*z.^2 + 105*x.^2.*y.^4 - 420*x.^2.*y.^2.*z.^2 + 168*x.^2.*z.^4 + 35*y.^6 - 210*y.^4.*z.^2 + 168*y.^2.*z.^4 - 16*z.^6))/16;
                case 1
                    SHfield=-(7*x.*(5*x.^6 + 15*x.^4.*y.^2 - 120*x.^4.*z.^2 + 15*x.^2.*y.^4 - 240*x.^2.*y.^2.*z.^2 + 240*x.^2.*z.^4 + 5*y.^6 - 120*y.^4.*z.^2 + 240*y.^2.*z.^4 - 64*z.^6))/16;
                case 2
                    SHfield=(63*z.*(x.^2 - y.^2).*(15*x.^4 + 30*x.^2.*y.^2 - 80*x.^2.*z.^2 + 15*y.^4 - 80*y.^2.*z.^2 + 48*z.^4))/8;
                case 3
                    SHfield=(315*x.*(x.^2 - 3*y.^2).*(3*x.^4 + 6*x.^2.*y.^2 - 60*x.^2.*z.^2 + 3*y.^4 - 60*y.^2.*z.^2 + 80*z.^4))/8;
                case 4
                    SHfield=-(3465*z.*(3*x.^2 + 3*y.^2 - 10*z.^2).*(x.^4 - 6*x.^2.*y.^2 + y.^4))/2;
                case 5
                    SHfield=-(10395*x.*(x.^2 + y.^2 - 12*z.^2).*(x.^4 - 10*x.^2.*y.^2 + 5*y.^4))/2;
                case 6
                    SHfield=135135*z.*(x.^6 - 15*x.^4.*y.^2 + 15*x.^2.*y.^4 - y.^6);
                case 7
                    SHfield=135135*x.*(x.^6 - 21*x.^4.*y.^2 + 35*x.^2.*y.^4 - 7*y.^6);
            end
        case 8
            switch degree
                case -8
                    SHfield=16216200*x.*y.*(x.^6 - 7*x.^4.*y.^2 + 7*x.^2.*y.^4 - y.^6);
                case -7
                    SHfield=2027025*y.*z.*(7*x.^6 - 35*x.^4.*y.^2 + 21*x.^2.*y.^4 - y.^6);
                case -6
                    SHfield=-135135*x.*y.*(x.^2 + y.^2 - 14*z.^2).*(3*x.^4 - 10*x.^2.*y.^2 + 3*y.^4);
                case -5
                    SHfield=-(135135*y.*z.*(x.^2 + y.^2 - 4*z.^2).*(5*x.^4 - 10*x.^2.*y.^2 + y.^4))/2;
                case -4
                    SHfield=(10395*x.*y.*(x.^2 - y.^2).*(x.^4 + 2*x.^2.*y.^2 - 24*x.^2.*z.^2 + y.^4 - 24*y.^2.*z.^2 + 40*z.^4))/2;
                case -3
                    SHfield=(3465*y.*z.*(3*x.^2 - y.^2).*(3*x.^4 + 6*x.^2.*y.^2 - 20*x.^2.*z.^2 + 3*y.^4 - 20*y.^2.*z.^2 + 16*z.^4))/8;
                case -2
                    SHfield=-(315*x.*y.*(x.^6 + 3*x.^4.*y.^2 - 30*x.^4.*z.^2 + 3*x.^2.*y.^4 - 60*x.^2.*y.^2.*z.^2 + 80*x.^2.*z.^4 + y.^6 - 30*y.^4.*z.^2 + 80*y.^2.*z.^4 - 32*z.^6))/8;
                case -1
                    SHfield=-(9*y.*z.*(35*x.^6 + 105*x.^4.*y.^2 - 280*x.^4.*z.^2 + 105*x.^2.*y.^4 - 560*x.^2.*y.^2.*z.^2 + 336*x.^2.*z.^4 + 35*y.^6 - 280*y.^4.*z.^2 + 336*y.^2.*z.^4 - 64*z.^6))/16;
                case 0
                    SHfield=(35*x.^8)/128 + (35*x.^6.*y.^2)/32 - (35*x.^6.*z.^2)/4 + (105*x.^4.*y.^4)/64 - (105*x.^4.*y.^2.*z.^2)/4 + (105*x.^4.*z.^4)/4 + (35*x.^2.*y.^6)/32 - (105*x.^2.*y.^4.*z.^2)/4 + (105*x.^2.*y.^2.*z.^4)/2 - 14*x.^2.*z.^6 + (35*y.^8)/128 - (35*y.^6.*z.^2)/4 + (105*y.^4.*z.^4)/4 - 14*y.^2.*z.^6 + z.^8;
                case 1
                    SHfield=-(9*x.*z.*(35*x.^6 + 105*x.^4.*y.^2 - 280*x.^4.*z.^2 + 105*x.^2.*y.^4 - 560*x.^2.*y.^2.*z.^2 + 336*x.^2.*z.^4 + 35*y.^6 - 280*y.^4.*z.^2 + 336*y.^2.*z.^4 - 64*z.^6))/16;
                case 2
                    SHfield=-(315*(x.^2 - y.^2).*(x.^6 + 3*x.^4.*y.^2 - 30*x.^4.*z.^2 + 3*x.^2.*y.^4 - 60*x.^2.*y.^2.*z.^2 + 80*x.^2.*z.^4 + y.^6 - 30*y.^4.*z.^2 + 80*y.^2.*z.^4 - 32*z.^6))/16;
                case 3
                    SHfield=(3465*x.*z.*(x.^2 - 3*y.^2).*(3*x.^4 + 6*x.^2.*y.^2 - 20*x.^2.*z.^2 + 3*y.^4 - 20*y.^2.*z.^2 + 16*z.^4))/8;
                case 4
                    SHfield=(10395*(x.^4 - 6*x.^2.*y.^2 + y.^4).*(x.^4 + 2*x.^2.*y.^2 - 24*x.^2.*z.^2 + y.^4 - 24*y.^2.*z.^2 + 40*z.^4))/8;
                case 5
                    SHfield=-(135135*x.*z.*(x.^2 + y.^2 - 4*z.^2).*(x.^4 - 10*x.^2.*y.^2 + 5*y.^4))/2;
                case 6
                    SHfield=-(135135*(x.^2 + y.^2 - 14*z.^2).*(x.^6 - 15*x.^4.*y.^2 + 15*x.^2.*y.^4 - y.^6))/2;
                case 7
                    SHfield=2027025*x.*z.*(x.^6 - 21*x.^4.*y.^2 + 35*x.^2.*y.^4 - 7*y.^6);
                case 8
                    SHfield=2027025*x.^8 - 56756700*x.^6.*y.^2 + 141891750*x.^4.*y.^4 - 56756700*x.^2.*y.^6 + 2027025*y.^8;
            end
        case 9
            switch degree
                case -9
                    SHfield=34459425*y.*(9*x.^8 - 84*x.^6.*y.^2 + 126*x.^4.*y.^4 - 36*x.^2.*y.^6 + y.^8);
                case -8
                    SHfield=275675400*x.*y.*z.*(x.^6 - 7*x.^4.*y.^2 + 7*x.^2.*y.^4 - y.^6);
                case -7
                    SHfield=-(2027025*y.*(x.^2 + y.^2 - 16*z.^2).*(7*x.^6 - 35*x.^4.*y.^2 + 21*x.^2.*y.^4 - y.^6))/2;
                case -6
                    SHfield=-675675*x.*y.*z.*(3*x.^2 + 3*y.^2 - 14*z.^2).*(3*x.^4 - 10*x.^2.*y.^2 + 3*y.^4);
                case -5
                    SHfield=(135135*y.*(5*x.^4 - 10*x.^2.*y.^2 + y.^4).*(x.^4 + 2*x.^2.*y.^2 - 28*x.^2.*z.^2 + y.^4 - 28*y.^2.*z.^2 + 56*z.^4))/8;
                case -4
                    SHfield=(135135*x.*y.*z.*(x.^2 - y.^2).*(x.^4 + 2*x.^2.*y.^2 - 8*x.^2.*z.^2 + y.^4 - 8*y.^2.*z.^2 + 8*z.^4))/2;
                case -3
                    SHfield=-(3465*y.*(3*x.^2 - y.^2).*(x.^6 + 3*x.^4.*y.^2 - 36*x.^4.*z.^2 + 3*x.^2.*y.^4 - 72*x.^2.*y.^2.*z.^2 + 120*x.^2.*z.^4 + y.^6 - 36*y.^4.*z.^2 + 120*y.^2.*z.^4 - 64*z.^6))/16;
                case -2
                    SHfield=-(495*x.*y.*z.*(7*x.^6 + 21*x.^4.*y.^2 - 70*x.^4.*z.^2 + 21*x.^2.*y.^4 - 140*x.^2.*y.^2.*z.^2 + 112*x.^2.*z.^4 + 7*y.^6 - 70*y.^4.*z.^2 + 112*y.^2.*z.^4 - 32*z.^6))/8;
                case -1
                    SHfield=(45*y.*(7*x.^8 + 28*x.^6.*y.^2 - 280*x.^6.*z.^2 + 42*x.^4.*y.^4 - 840*x.^4.*y.^2.*z.^2 + 1120*x.^4.*z.^4 + 28*x.^2.*y.^6 - 840*x.^2.*y.^4.*z.^2 + 2240*x.^2.*y.^2.*z.^4 - 896*x.^2.*z.^6 + 7*y.^8 - 280*y.^6.*z.^2 + 1120*y.^4.*z.^4 - 896*y.^2.*z.^6 + 128*z.^8))/128;
                case 0
                    SHfield=(z.*(315*x.^8 + 1260*x.^6.*y.^2 - 3360*x.^6.*z.^2 + 1890*x.^4.*y.^4 - 10080*x.^4.*y.^2.*z.^2 + 6048*x.^4.*z.^4 + 1260*x.^2.*y.^6 - 10080*x.^2.*y.^4.*z.^2 + 12096*x.^2.*y.^2.*z.^4 - 2304*x.^2.*z.^6 + 315*y.^8 - 3360*y.^6.*z.^2 + 6048*y.^4.*z.^4 - 2304*y.^2.*z.^6 + 128*z.^8))/128;
                case 1
                    SHfield=(45*x.*(7*x.^8 + 28*x.^6.*y.^2 - 280*x.^6.*z.^2 + 42*x.^4.*y.^4 - 840*x.^4.*y.^2.*z.^2 + 1120*x.^4.*z.^4 + 28*x.^2.*y.^6 - 840*x.^2.*y.^4.*z.^2 + 2240*x.^2.*y.^2.*z.^4 - 896*x.^2.*z.^6 + 7*y.^8 - 280*y.^6.*z.^2 + 1120*y.^4.*z.^4 - 896*y.^2.*z.^6 + 128*z.^8))/128;
                case 2
                    SHfield=-(495*z.*(x.^2 - y.^2).*(7*x.^6 + 21*x.^4.*y.^2 - 70*x.^4.*z.^2 + 21*x.^2.*y.^4 - 140*x.^2.*y.^2.*z.^2 + 112*x.^2.*z.^4 + 7*y.^6 - 70*y.^4.*z.^2 + 112*y.^2.*z.^4 - 32*z.^6))/16;
                case 3
                    SHfield=-(3465*x.*(x.^2 - 3*y.^2).*(x.^6 + 3*x.^4.*y.^2 - 36*x.^4.*z.^2 + 3*x.^2.*y.^4 - 72*x.^2.*y.^2.*z.^2 + 120*x.^2.*z.^4 + y.^6 - 36*y.^4.*z.^2 + 120*y.^2.*z.^4 - 64*z.^6))/16;
                case 4
                    SHfield=(135135*z.*(x.^4 - 6*x.^2.*y.^2 + y.^4).*(x.^4 + 2*x.^2.*y.^2 - 8*x.^2.*z.^2 + y.^4 - 8*y.^2.*z.^2 + 8*z.^4))/8;
                case 5
                    SHfield=(135135*x.*(x.^4 - 10*x.^2.*y.^2 + 5*y.^4).*(x.^4 + 2*x.^2.*y.^2 - 28*x.^2.*z.^2 + y.^4 - 28*y.^2.*z.^2 + 56*z.^4))/8;
                case 6
                    SHfield=-(675675*z.*(3*x.^2 + 3*y.^2 - 14*z.^2).*(x.^6 - 15*x.^4.*y.^2 + 15*x.^2.*y.^4 - y.^6))/2;
                case 7
                    SHfield=-(2027025*x.*(x.^2 + y.^2 - 16*z.^2).*(x.^6 - 21*x.^4.*y.^2 + 35*x.^2.*y.^4 - 7*y.^6))/2;
                case 8
                    SHfield=34459425*z.*(x.^8 - 28*x.^6.*y.^2 + 70*x.^4.*y.^4 - 28*x.^2.*y.^6 + y.^8);
                case 9
                    SHfield=34459425*x.*(x.^8 - 36*x.^6.*y.^2 + 126*x.^4.*y.^4 - 84*x.^2.*y.^6 + 9*y.^8);
            end
        case 10
            switch degree
                case -10
                    SHfield=1309458150*x.*y.*(5*x.^8 - 60*x.^6.*y.^2 + 126*x.^4.*y.^4 - 60*x.^2.*y.^6 + 5*y.^8);
                case -9
                    SHfield=654729075*y.*z.*(9*x.^8 - 84*x.^6.*y.^2 + 126*x.^4.*y.^4 - 36*x.^2.*y.^6 + y.^8);
                case -8
                    SHfield=-137837700*x.*y.*(x.^2 + y.^2 - 18*z.^2).*(x.^6 - 7*x.^4.*y.^2 + 7*x.^2.*y.^4 - y.^6);
                case -7
                    SHfield=-(11486475*y.*z.*(3*x.^2 + 3*y.^2 - 16*z.^2).*(7*x.^6 - 35*x.^4.*y.^2 + 21*x.^2.*y.^4 - y.^6))/2;
                case -6
                    SHfield=(675675*x.*y.*(3*x.^4 - 10*x.^2.*y.^2 + 3*y.^4).*(3*x.^4 + 6*x.^2.*y.^2 - 96*x.^2.*z.^2 + 3*y.^4 - 96*y.^2.*z.^2 + 224*z.^4))/4;
                case -5
                    SHfield=(135135*y.*z.*(5*x.^4 - 10*x.^2.*y.^2 + y.^4).*(15*x.^4 + 30*x.^2.*y.^2 - 140*x.^2.*z.^2 + 15*y.^4 - 140*y.^2.*z.^2 + 168*z.^4))/8;
                case -4
                    SHfield=-(45045*x.*y.*(x.^2 - y.^2).*(x.^6 + 3*x.^4.*y.^2 - 42*x.^4.*z.^2 + 3*x.^2.*y.^4 - 84*x.^2.*y.^2.*z.^2 + 168*x.^2.*z.^4 + y.^6 - 42*y.^4.*z.^2 + 168*y.^2.*z.^4 - 112*z.^6))/4;
                case -3
                    SHfield=-(6435*y.*z.*(3*x.^2 - y.^2).*(7*x.^6 + 21*x.^4.*y.^2 - 84*x.^4.*z.^2 + 21*x.^2.*y.^4 - 168*x.^2.*y.^2.*z.^2 + 168*x.^2.*z.^4 + 7*y.^6 - 84*y.^4.*z.^2 + 168*y.^2.*z.^4 - 64*z.^6))/16;
                case -2
                    SHfield=(495*x.*y.*(7*x.^8 + 28*x.^6.*y.^2 - 336*x.^6.*z.^2 + 42*x.^4.*y.^4 - 1008*x.^4.*y.^2.*z.^2 + 1680*x.^4.*z.^4 + 28*x.^2.*y.^6 - 1008*x.^2.*y.^4.*z.^2 + 3360*x.^2.*y.^2.*z.^4 - 1792*x.^2.*z.^6 + 7*y.^8 - 336*y.^6.*z.^2 + 1680*y.^4.*z.^4 - 1792*y.^2.*z.^6 + 384*z.^8))/64;
                case -1
                    SHfield=(55*y.*z.*(63*x.^8 + 252*x.^6.*y.^2 - 840*x.^6.*z.^2 + 378*x.^4.*y.^4 - 2520*x.^4.*y.^2.*z.^2 + 2016*x.^4.*z.^4 + 252*x.^2.*y.^6 - 2520*x.^2.*y.^4.*z.^2 + 4032*x.^2.*y.^2.*z.^4 - 1152*x.^2.*z.^6 + 63*y.^8 - 840*y.^6.*z.^2 + 2016*y.^4.*z.^4 - 1152*y.^2.*z.^6 + 128*z.^8))/128;
                case 0
                    SHfield=- (63*x.^10)/256 - (315*x.^8.*y.^2)/256 + (1575*x.^8.*z.^2)/128 - (315*x.^6.*y.^4)/128 + (1575*x.^6.*y.^2.*z.^2)/32 - (525*x.^6.*z.^4)/8 - (315*x.^4.*y.^6)/128 + (4725*x.^4.*y.^4.*z.^2)/64 - (1575*x.^4.*y.^2.*z.^4)/8 + (315*x.^4.*z.^6)/4 - (315*x.^2.*y.^8)/256 + (1575*x.^2.*y.^6.*z.^2)/32 - (1575*x.^2.*y.^4.*z.^4)/8 + (315*x.^2.*y.^2.*z.^6)/2 - (45*x.^2.*z.^8)/2 - (63*y.^10)/256 + (1575*y.^8.*z.^2)/128 - (525*y.^6.*z.^4)/8 + (315*y.^4.*z.^6)/4 - (45*y.^2.*z.^8)/2 + z.^10;
                case 1
                    SHfield=(55*x.*z.*(63*x.^8 + 252*x.^6.*y.^2 - 840*x.^6.*z.^2 + 378*x.^4.*y.^4 - 2520*x.^4.*y.^2.*z.^2 + 2016*x.^4.*z.^4 + 252*x.^2.*y.^6 - 2520*x.^2.*y.^4.*z.^2 + 4032*x.^2.*y.^2.*z.^4 - 1152*x.^2.*z.^6 + 63*y.^8 - 840*y.^6.*z.^2 + 2016*y.^4.*z.^4 - 1152*y.^2.*z.^6 + 128*z.^8))/128;
                case 2
                    SHfield=(495*(x.^2 - y.^2).*(7*x.^8 + 28*x.^6.*y.^2 - 336*x.^6.*z.^2 + 42*x.^4.*y.^4 - 1008*x.^4.*y.^2.*z.^2 + 1680*x.^4.*z.^4 + 28*x.^2.*y.^6 - 1008*x.^2.*y.^4.*z.^2 + 3360*x.^2.*y.^2.*z.^4 - 1792*x.^2.*z.^6 + 7*y.^8 - 336*y.^6.*z.^2 + 1680*y.^4.*z.^4 - 1792*y.^2.*z.^6 + 384*z.^8))/128;
                case 3
                    SHfield=-(6435*x.*z.*(x.^2 - 3*y.^2).*(7*x.^6 + 21*x.^4.*y.^2 - 84*x.^4.*z.^2 + 21*x.^2.*y.^4 - 168*x.^2.*y.^2.*z.^2 + 168*x.^2.*z.^4 + 7*y.^6 - 84*y.^4.*z.^2 + 168*y.^2.*z.^4 - 64*z.^6))/16;
                case 4
                    SHfield=-(45045*(x.^4 - 6*x.^2.*y.^2 + y.^4).*(x.^6 + 3*x.^4.*y.^2 - 42*x.^4.*z.^2 + 3*x.^2.*y.^4 - 84*x.^2.*y.^2.*z.^2 + 168*x.^2.*z.^4 + y.^6 - 42*y.^4.*z.^2 + 168*y.^2.*z.^4 - 112*z.^6))/16;
                case 5
                    SHfield=(135135*x.*z.*(x.^4 - 10*x.^2.*y.^2 + 5*y.^4).*(15*x.^4 + 30*x.^2.*y.^2 - 140*x.^2.*z.^2 + 15*y.^4 - 140*y.^2.*z.^2 + 168*z.^4))/8;
                case 6
                    SHfield=(675675*(x.^6 - 15*x.^4.*y.^2 + 15*x.^2.*y.^4 - y.^6).*(3*x.^4 + 6*x.^2.*y.^2 - 96*x.^2.*z.^2 + 3*y.^4 - 96*y.^2.*z.^2 + 224*z.^4))/8;
                case 7
                    SHfield=-(11486475*x.*z.*(3*x.^2 + 3*y.^2 - 16*z.^2).*(x.^6 - 21*x.^4.*y.^2 + 35*x.^2.*y.^4 - 7*y.^6))/2;
                case 8
                    SHfield=-(34459425*(x.^2 + y.^2 - 18*z.^2).*(x.^8 - 28*x.^6.*y.^2 + 70*x.^4.*y.^4 - 28*x.^2.*y.^6 + y.^8))/2;
                case 9
                    SHfield=654729075*x.*z.*(x.^8 - 36*x.^6.*y.^2 + 126*x.^4.*y.^4 - 84*x.^2.*y.^6 + 9*y.^8);
                case 10
                    SHfield=654729075*x.^10 - 29462808375*x.^8.*y.^2 + 137493105750*x.^6.*y.^4 - 137493105750*x.^4.*y.^6 + 29462808375*x.^2.*y.^8 - 654729075*y.^10;
            end
    end
end
end